name: Deploy to Fly.io

on:
  workflow_run:
    workflows: ["Docker Bake Build and Push"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: actor
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}   # ✅ Global export

    steps:
    # ---------------------------------------
    # CHECKOUT REPOSITORY
    # ---------------------------------------
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main         # ✅ Ensures you're on a real branch

    # ---------------------------------------
    # LOGIN TO GHCR
    # ---------------------------------------
    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: khalith
        password: ${{ secrets.GHCR_PAT }}

    # ---------------------------------------
    # INSTALL FLYCTL
    # ---------------------------------------
    - name: Install Flyctl
      uses: superfly/flyctl-actions/setup-flyctl@v1

    # ---------------------------------------
    # VERIFY AUTH
    # ---------------------------------------
    - name: Verify Flyctl auth
      run: flyctl auth whoami

    # ======================================
    # ENSURE VOLUME EXIST
    # ======================================
    - name: Ensure backend volume exists
      run: |
        flyctl volumes create uploads \
          --size 1 \
          --region bom \
          -a mailscout-backend \
          --yes || true

    # ======================================
    # DEPLOY APPLICATIONS
    # ======================================

    # BACKEND DEPLOY
    - name: Deploy backend
      run: |
        flyctl deploy \
          --config backend/fly.backend.toml \
          --image ghcr.io/khalith/mailscout-backend:${{ github.ref_name }} \
          --detach \
          -a mailscout-backend

    # WORKER DEPLOY
    - name: Deploy worker
      run: |
        flyctl deploy \
          --config worker/fly.worker.toml \
          --image ghcr.io/khalith/mailscout-worker:${{ github.ref_name }} \
          --detach \
          -a mailscout-worker

    # AUTOSCALER DEPLOY
    - name: Deploy autoscaler
      run: |
        flyctl deploy \
          --config autoscaler/fly.autoscaler.toml \
          --image ghcr.io/khalith/mailscout-autoscaler:${{ github.ref_name }} \
          --detach \
          -a mailscout-autoscaler

    # FRONTEND DEPLOY
    - name: Deploy frontend
      run: |
        flyctl deploy \
          --config frontend/fly.frontend.toml \
          --image ghcr.io/khalith/mailscout-frontend:${{ github.ref_name }} \
          --detach \
          -a mailscout-frontend

    # ======================================
    # SET BACKEND SECRETS
    # ======================================
    - name: Set backend secrets
      run: |
        flyctl secrets set \
          DATABASE_URL="${{ vars.DATABASE_URL }}" \
          REDIS_URL="${{ vars.REDIS_URL }}" \
          QUEUE_KEY="${{ vars.QUEUE_KEY }}" \
          CHUNK_SIZE="${{ vars.CHUNK_SIZE }}" \
          UPLOAD_PATH="/data/uploads" \
          -a mailscout-backend

    # ======================================
    # SET WORKER SECRETS
    # ======================================
    - name: Set worker secrets
      run: |
        flyctl secrets set \
          REDIS_URL="${{ vars.REDIS_URL }}" \
          QUEUE_KEY="${{ vars.QUEUE_KEY }}" \
          CONCURRENCY="${{ vars.CONCURRENCY }}" \
          PER_MX_LIMIT="${{ vars.PER_MX_LIMIT }}" \
          WORKER_SMTP="${{ vars.SMTP }}" \
          MX_CONCURRENCY="${{ vars.MX_CONCURRENCY }}" \
          BATCH_INSERT="${{ vars.BATCH_INSERT }}" \
          -a mailscout-worker

    # ======================================
    # SET AUTOSCALER SECRETS
    # ======================================
    - name: Set autoscaler secrets
      run: |
        flyctl secrets set \
          REDIS_URL="${{ vars.REDIS_URL }}" \
          QUEUE_KEY="${{ vars.QUEUE_KEY }}" \
          MIN_WORKERS="${{ vars.MIN_WORKERS }}" \
          MAX_WORKERS="${{ vars.MAX_WORKERS }}" \
          SCALE_UP_THRESHOLD="${{ vars.SCALE_UP_THRESHOLD }}" \
          SCALE_DOWN_THRESHOLD="${{ vars.SCALE_DOWN_THRESHOLD }}" \
          INTERVAL="${{ vars.INTERVAL }}" \
          -a mailscout-autoscaler

    # ======================================
    # SET FRONTEND SECRETS
    # ======================================
    - name: Set frontend secrets
      run: |
        flyctl secrets set \
          VITE_API_URL="${{ vars.VITE_API_URL }}" \
          -a mailscout-frontend
